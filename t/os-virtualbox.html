                          <h1 class="title">Register Virtual Box Image on OpenStack</h1>
  
  
  <div class="content">
    <p>In this tutorial we explain how to convert a Virtual Box image to kvm format and then register it on OpenStack.</p>
<h2>Prerequisites</h2>
<p>There is two main prerequisites for your images to work with OpenStack</p>
<h3>Disable SELinux (Only for RedHat-based Linux like CentOS)</h3>
<p>Edit the file&nbsp;/etc/selinux/config and set the SELINUX option to disabled</p>
<pre>SELINUX=disabled</pre><h3>Configuring the image network interface (eth0) for DHCP</h3>
<p>In Ubuntu, you edit the file /etc/network/interfaces and configure eth0 to:</p>
<pre>auto eth0
iface eth0 inet dhcp</pre><div>In CentOS, you edit the file /etc/sysconfig/network-scripts/ifcfg-eth0 and make sure it contains:</p>
<pre>DEVICE=eth0
BOOTPROTO=dhcp
ONBOOT=yes</pre></div>
<h3>Configure the image to allow OpenStack to inject the ssh key&nbsp;</h3>
<ul>
<li>Ubuntu&nbsp;(it may not be needed for Ubuntu, but it is recomended)</li>
</ul>
<pre class="rteindent2">$ sudo apt-get install cloud-init curl</pre><ul>
<li>CentOS.&nbsp;Edit the file /etc/rc.local</li>
</ul>
<pre class="rteindent2">route del -net 169.254.0.0 netmask 255.255.0.0 dev eth0
# load pci hotplug for dynamic disk attach in KVM (for EBS)
depmod -a
modprobe acpiphp

# simple attempt to get the user ssh key using the meta-data service
mkdir -p /root/.ssh
echo &gt;&gt; /root/.ssh/authorized_keys
curl -m 10 -s <a href="http://169.254.169.254/latest/meta-data/public-keys/0/openssh-key" title="http://169.254.169.254/latest/meta-data/public-keys/0/openssh-key">http://169.254.169.254/latest/meta-data/public-keys/0/openssh-key</a> | grep &#39;ssh-rsa&#39; &gt;&gt; /root/.ssh/authorized_keys
echo &quot;AUTHORIZED_KEYS:&quot;
echo &quot;************************&quot;
cat /root/.ssh/authorized_keys
echo &quot;************************&quot;</pre><h3>Configure udev persistent rules (only CentOS)</h3>
<p>Edit the file&nbsp;/etc/udev/rules.d/70-persistent-net.rules, delete everything and add:</p>
<pre>ACTION==&quot;add&quot;,SUBSYSTEM==&quot;net&quot;, IMPORT{program}=&quot;/lib/udev/rename_device&quot;
SUBSYSTEM==&quot;net&quot;, RUN+=&quot;/etc/sysconfig/network-scripts/net.hotplug&quot;</pre><h2>Convert your virtual box image to raw format</h2>
<pre>VBoxManage clonehd /path/to/imagefile/vboximage.vdi /path/to/rawimage.img --format raw</pre><p>Make sure that you specify the full path. Otherwise, you may experience errors and the new image will be placed in&nbsp;<span style="color: rgb(41, 41, 41); font-family: Helvetica; font-size: 13px; line-height: 16px; ">&nbsp;~/.VirtualBox/HardDisks/</span></p>
<h2>Convert the image to qcow2 format (optional)</h2>
<p>This step is optional, but it is recommended if your image as a considerable size because the qcow2 format will compress your image. Nevertheless, it will takes a while to finish this command. As example my 8GB image took a couple of hours to get ready and was compressed to less than 6 GB.</p>
<pre>qemu-img convert -f raw rawimage.img -O qcow2 qcow2image.img</pre><h2>Test your image</h2>
<p>If you are in a computer with graphical interface, the easiest way to test it is by executing the following command. This command will open a window and you will see if your image boots correctly.</p>
<pre>kvm -hda rawimage.img -m 1024</pre><p>or</p>
<pre>kvm -hda qcow2image.img -m 1024</pre><p>From now on, we refer only to the rawimage.img, but it works in the same way with the qcow2image.img.</p>
<h2>Transfer your Image to India</h2>
<pre>$ scp rawimage.img &lt;username&gt;@india.futuregrid.org:/N/u/&lt;username&gt;/</pre><h2>Log into India</h2>
<pre>$ ssh &lt;username&gt;@india.futuregrid.org</pre><pre></pre><h2>Upload your image to OpenStack</h2>
<p>First, we need to load the euca2ools module that contains the command line interface to interact with OpenStack. Then we need to load our own credentials that are typically in a novarc file. Finally you update and register the image. Although, we are going to briefly explain these steps here, this is part of the OpenStack tutorial that can be found in&nbsp;<a href="https://portal.futuregrid.org/tutorials/openstack">https://portal.futuregrid.org/tutorials/openstack</a>.</p>
<pre>$ module load euca2ools
$ source ~/novarc</pre><p>Upload the image</p>
<pre>$ euca-bundle-image -i rawimage.img 

Checking image
Encrypting image
Splitting image...
Part: rawimage.img.part.00
Part: rawimage.img.part.01
Part: rawimage.img.part.02
.....
Generating manifest /tmp/rawimage.img.manifest.xml</pre><p>At the end you get a manifest file that you use in the next step. You also need to specify a bucket name (option -b). We can use our username (jdiazz in my case), but it can be any other string.</p>
<pre>$ euca-upload-image -m /tmp/rawimage.img.manifest.xml -b jdiazz

Checking bucket: jdiaz
Uploading manifest file
Uploading part: rawimage.img.part.00
Uploading part: rawimage.img.part.01
Uploading part: rawimage.img.part.02
.....
Uploaded image as jdiazz/rawimage.img.manifest.xml</pre><p>Finally we register the image.</p>
<pre>$ euca-register jdiazz/rawimage.img.manifest.xml

IMAGE <span style="background-color:#ffff00;">ami-00000058</span></pre><p>From this last command we get the ami-ID that identifies the image in OpenStack (marked in yellow). You will need this to start instances.</p>
<h2>Checking Status Image</h2>
<p>You cannot run instances until your image is in available status. You can check the status of your image with the euca-describe-images command. This command can take some time to respond because the system will be busy processing your image.</p>
<pre>$ euca-describe-images ami-00000058</pre><h2>Test Image in OpenStack</h2>
<p>For this step we recomend to go to the OpenStack tutorial where we explain how to create a key-pair and run an instance with our image. Please see&nbsp;<a href="https://portal.futuregrid.org/using-openstack-futuregrid#key_management">https://portal.futuregrid.org/using-openstack-futuregrid#key_management</a></p>
<p>Running the instance can be something like this:</p>
<pre>$ euca-run-instances -k jdiaznova ami-00000058 -t m1.large</pre><p>where jdiaznova is the key name of my openstack key pairs. This key will allow us to ssh into the image. Please refer to the OpenStack tutorial for more information.</p>
<h2>Troubleshooting</h2>
<p>One problem of this way of using our images is that we cannot use euca-get-console-output command to debug the boot process of the images. Therefore it makes more complicated solving runtime problems. However, if your image boots properly when doing the &quot;Test your Image&quot; section, it should work also on OpenStack and the only problem could be wrong configuration of network interface or SELinux enabled.</p>
<h2>Notes:</h2>
<p>This tutorial has been tested with Ubuntu 12 and CentOS 6 using OpenStack Essex.&nbsp;</p>
  <div id="book-navigation-104" class="book-navigation">
    
        <div class="page-links clear-block">
              <a href="/tutorials/one-click-twister-k-means-eucalyptus-futuregrid" class="page-previous" title="Go to previous page">‹ One-click Twister K-means on Eucalyptus FutureGrid</a>
                    <a href="/tutorials" class="page-up" title="Go to parent page">up</a>
                    <a href="/community/appliances" class="page-next" title="Go to next page">Virtual Appliances ›</a>
          </div>
    
  </div>
  </div>
